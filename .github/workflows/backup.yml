name: Backup diario CSJ con Release, retención e index HTML

on:
  schedule:
    - cron: "0 12 * * *"  # Todos los días a las 12:00 UTC
  workflow_dispatch:       # Permite ejecución manual

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Definir fecha
        id: fecha
        run: echo "today=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Crear carpeta por fecha
        run: |
          mkdir -p "backup/${{ steps.fecha.outputs.today }}"

      - name: Descargar documento público ignorando SSL
        run: |
          curl -k -L -o "backup/${{ steps.fecha.outputs.today }}/DocumentoJurisprudencia.doc" \
            "https://www.csj.gov.py/jurisprudencia/home/DocumentoJurisprudencia?codigo=18"

      - name: Calcular hash SHA256 y registrar nombre original
        run: |
          TODAY=${{ steps.fecha.outputs.today }}
          ORIGINAL_NAME="562436A38CDAB4A921A78FA09AFFC066.doc"
          sha256sum "backup/$TODAY/DocumentoJurisprudencia.doc" > "backup/$TODAY/metadata.txt"
          echo "Nombre original: $ORIGINAL_NAME" >> "backup/$TODAY/metadata.txt"
          echo "Fecha UTC: $(date -u)" >> "backup/$TODAY/metadata.txt"
          echo "Fuente: https://www.csj.gov.py/jurisprudencia/home/DocumentoJurisprudencia?codigo=18" >> "backup/$TODAY/metadata.txt"

      - name: Commit y push de backup
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add backup/${{ steps.fecha.outputs.today }}/
          if ! git diff --quiet --cached; then
            git commit -m "Backup CSJ ${{ steps.fecha.outputs.today }}"
            git push origin main
          else
            echo "No hay cambios nuevos."
          fi

      - name: Crear Release GitHub con archivo adjunto
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=${{ steps.fecha.outputs.today }}
          gh release create backup-$TODAY \
            "backup/$TODAY/DocumentoJurisprudencia.doc" \
            --title "Backup CSJ $TODAY" \
            --notes "Backup diario de documento público CSJ. Hash SHA256 y nombre original incluido en metadata.txt." \
            --repo $GITHUB_REPOSITORY

      - name: Limitar releases a los últimos 7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASES=$(gh release list --limit 100 --repo $GITHUB_REPOSITORY | awk '{print $1}')
          COUNT=$(echo "$RELEASES" | wc -l)
          MAX_RELEASES=7
          if [ "$COUNT" -gt "$MAX_RELEASES" ]; then
            NUM_TO_DELETE=$((COUNT - MAX_RELEASES))
            TO_DELETE=$(echo "$RELEASES" | tail -n $NUM_TO_DELETE)
            for r in $TO_DELETE; do
              echo "Borrando release antigua: $r"
              gh release delete "$r" --repo $GITHUB_REPOSITORY --yes
            done
          fi

      - name: Generar index HTML de backups
        run: |
          INDEX_FILE="backup/index.html"
          echo "<!DOCTYPE html>" > $INDEX_FILE
          echo "<html><head><meta charset='UTF-8'><title>Backups CSJ</title></head><body>" >> $INDEX_FILE
          echo "<h1>Backups CSJ</h1><ul>" >> $INDEX_FILE

          for DIR in backup/*/ ; do
            [ "$DIR" = "backup/index.html" ] && continue
            DATE=$(basename $DIR)
            FILE="$DIR/DocumentoJurisprudencia.doc"
            META="$DIR/metadata.txt"

            if [ -f "$FILE" ]; then
              HASH=$(grep -oE '^[a-f0-9]{64}' "$META" || echo "N/A")
              ORIG=$(grep 'Nombre original:' "$META" | cut -d':' -f2- | xargs || echo "N/A")
              echo "<li><a href='$FILE'>$DATE</a> - SHA256: $HASH - Nombre original: $ORIG</li>" >> $INDEX_FILE
            fi
          done

          echo "</ul></body></html>" >> $INDEX_FILE

      - name: Commit y push del index HTML
        run: |
          git add backup/index.html
          if ! git diff --quiet --cached; then
            git commit -m "Actualizar index HTML de backups CSJ ${{ steps.fecha.outputs.today }}"
            git push origin main
          else
            echo "No hay cambios nuevos en index.html."
